// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MODERATOR
  ADMIN
  CAREGIVER
  ELDERLY
}

enum NotificationType {
  URGENCY // SpO₂ low + fall (extreme cas)
  ATTENTION // Low SpO₂, altered BPM, etc.
  FALL // Blocked drop
  LOW_SPO2 // Low saturation
  HIGH_BPM // Calm highs
  GENERIC // General warnings
}

enum NotificationStatus {
  PENDING
  SENT
  READ
}

enum NotificationChannel {
  DASHBOARD
  EMAIL
  WHATSAPP
}

enum SubscriptionPaymentStatus {
  REQUIRES_PAYMENT_METHOD
  REQUIRES_CONFIRMATION
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  EXPIRED
  TRIALING
  PAST_DUE
  UNPAID
}

enum PaymentMethod {
  CARD
  PIX
}

enum PlanInterval {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model User {
  id       String   @id @default(uuid())
  name     String
  document String   @unique
  email    String   @unique
  password String
  role     UserRole

  ownDevice     Device?        @relation("DeviceOwner")
  careDevices   Device[]       @relation("DeviceCaregiver")
  notifications Notification[]

  subscription Subscription?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Subscription {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  planId String @map("plan_id")
  plan   Plan   @relation(fields: [planId], references: [id])

  status      SubscriptionStatus
  startAt     DateTime           @default(now()) @map("start_at")
  endAt       DateTime?          @map("end_at")
  renewAt     DateTime?          @map("renew_at")
  trialEndsAt DateTime?          @map("trial_ends_at")
  cancelAt    DateTime?          @map("cancel_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  payments SubscriptionPayment[]

  @@map("subscription")
}

model SubscriptionPayment {
  id             String       @id @default(uuid())
  subscriptionId String       @map("subscription_id")
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  amount        Decimal
  currency      String                    @default("BRL")
  method        PaymentMethod
  status        SubscriptionPaymentStatus
  transactionId String? // id no provedor externo
  attemptAt     DateTime                  @default(now()) @map("attempt_at")
  paidAt        DateTime?                 @map("paid_at")
  statusReason  String? // falha, rejeitado, saldo insuficiente

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscription_payments")
}

model Plan {
  id       String       @id @default(uuid())
  name     String       @unique
  price    Float
  period   PlanInterval // MONTHLY, YEARLY, etc.
  isMain   Boolean      @default(false) @map("is_main")
  isActive Boolean      @map("is_active")

  planBenefits  PlanBenefit[]
  subscriptions Subscription[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

model PlanBenefit {
  id          String @id @default(uuid())
  title       String
  description String
  planId      String @map("plan_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  plan Plan @relation(fields: [planId], references: [id])

  @@map("plan_benefits")
}

model Device {
  id           String @id @default(uuid())
  name         String
  serialNumber String @unique

  // Device owner (elderly person) — this is optional, as the device may still be without an owner.
  ownerId String @unique
  owner   User   @relation("DeviceOwner", fields: [ownerId], references: [id])

  // Responsible caregiver — required
  caregiverId String
  caregiver   User   @relation("DeviceCaregiver", fields: [caregiverId], references: [id])

  measurements  Measurement[]
  notifications Notification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("devices")
}

model Measurement {
  id           String  @id @default(uuid())
  deviceId     String
  bpm          Int
  spo2         Int
  fallDetected Boolean

  device Device @relation(fields: [deviceId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("measurements")
}

model Notification {
  id          String              @id @default(uuid())
  deviceId    String
  caregiverId String
  type        NotificationType
  status      NotificationStatus  @default(PENDING)
  channel     NotificationChannel @default(DASHBOARD)
  message     String

  device    Device @relation(fields: [deviceId], references: [id])
  caregiver User   @relation(fields: [caregiverId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notifications")
}
